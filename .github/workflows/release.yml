name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.0.4)"
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check release does not exist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists" >&2
            exit 1
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"

      - name: Install dependencies
        run: bun install

      - name: Build binaries
        run: bun run build:all

      - name: Zip binaries
        run: |
          mkdir -p dist-zip
          cd dist
          zip -9 ../dist-zip/llm-darwin-arm64.zip llm-darwin-arm64
          zip -9 ../dist-zip/llm-darwin-x64.zip llm-darwin-x64
          zip -9 ../dist-zip/llm-linux-x64.zip llm-linux-x64
          zip -9 ../dist-zip/llm-linux-arm64.zip llm-linux-arm64
          zip -9 ../dist-zip/llm-windows-x64.zip llm-windows-x64.exe

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREV_TAG=$(git tag --list "v*" --sort=-creatordate | grep -v "^$TAG$" | head -n 1)
          if [[ -n "$PREV_TAG" ]]; then
            CHANGELOG=$(git log "$PREV_TAG"..HEAD --oneline)
          else
            CHANGELOG=$(git log --oneline)
          fi
          gh release create "$TAG" dist-zip/* --title "$TAG" --notes "$CHANGELOG" --latest
