#!/usr/bin/env bash
set -euo pipefail

usage() {
    cat <<'EOF'
llm Installer

Usage: install [options]

Options:
    -h, --help              Show this help
    -v, --version <version> Install a specific version (e.g., 0.0.1)
    --install-runtime       Install Node.js runtime if missing (default)

Examples:
    curl -fsSL https://raw.githubusercontent.com/taoalpha/llm/master/install | bash
    curl -fsSL https://raw.githubusercontent.com/taoalpha/llm/master/install | bash -s -- --version 0.0.1
    curl -fsSL https://raw.githubusercontent.com/taoalpha/llm/master/install | bash -s -- --install-runtime
EOF
}

requested_version=${VERSION:-}
install_runtime=1

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -v|--version)
            if [[ -n "${2:-}" ]]; then
                requested_version="$2"
                shift 2
            else
                echo "Error: --version requires a version argument" >&2
                exit 1
            fi
            ;;
        --install-runtime)
            install_runtime=1
            shift
            ;;
        *)
            echo "Warning: Unknown option '$1'" >&2
            shift
            ;;
    esac
done

raw_os=$(uname -s)
os=$(echo "$raw_os" | tr '[:upper:]' '[:lower:]')
case "$raw_os" in
    Darwin*) os="darwin" ;;
    Linux*) os="linux" ;;
    MINGW*|MSYS*|CYGWIN*) os="windows" ;;
esac

arch=$(uname -m)
if [[ "$arch" == "aarch64" ]]; then
    arch="arm64"
fi
if [[ "$arch" == "x86_64" ]]; then
    arch="x64"
fi

if [[ "$os" == "darwin" && "$arch" == "x64" ]]; then
    rosetta_flag=$(sysctl -n sysctl.proc_translated 2>/dev/null || echo 0)
    if [[ "$rosetta_flag" == "1" ]]; then
        arch="arm64"
    fi
fi

combo="$os-$arch"
case "$combo" in
    linux-x64|linux-arm64|darwin-x64|darwin-arm64|windows-x64)
        ;;
    *)
        echo "Unsupported OS/Arch: $os/$arch" >&2
        exit 1
        ;;
esac

if ! command -v unzip >/dev/null 2>&1; then
    echo "Error: 'unzip' is required but not installed." >&2
    exit 1
fi

has_node=0
if command -v node >/dev/null 2>&1; then
    has_node=1
fi

install_node() {
    echo "Installing Node.js via fnm..."
    if ! command -v fnm >/dev/null 2>&1; then
        if ! curl -fsSL https://fnm.vercel.app/install | bash; then
            echo "Error: fnm installation failed." >&2
            return 1
        fi
    fi

    export FNM_DIR="$HOME/.fnm"
    if [[ -d "$FNM_DIR" ]]; then
        export PATH="$FNM_DIR:$PATH"
    fi
    if command -v fnm >/dev/null 2>&1; then
        eval "$(fnm env 2>/dev/null)"
    fi

    if ! command -v fnm >/dev/null 2>&1; then
        echo "Error: fnm is not available in PATH." >&2
        return 1
    fi

    if ! fnm install --lts; then
        echo "Error: Node.js installation failed." >&2
        return 1
    fi
    fnm use --lts >/dev/null 2>&1 || true
    return 0
}

if [[ "$has_node" == "0" && "$install_runtime" == "1" ]]; then
    if install_node; then
        has_node=1
    else
        echo "Error: Failed to install Node.js runtime." >&2
        exit 1
    fi
fi

runtime=""
if [[ "$has_node" == "1" ]]; then
    runtime="node"
fi

filename="llm-${combo}.zip"
if [[ "$runtime" == "node" ]]; then
    filename="llm-node.zip"
fi

if [[ -z "$requested_version" ]]; then
    base_url="https://github.com/taoalpha/llm/releases/latest/download"
else
    requested_version="${requested_version#v}"
    base_url="https://github.com/taoalpha/llm/releases/download/v${requested_version}"
fi
url="${base_url}/${filename}"

install_dir="$HOME/.local/bin"
mkdir -p "$install_dir"

tmp_dir=$(mktemp -d)
trap 'rm -rf "$tmp_dir"' EXIT

if [[ "$runtime" == "node" ]]; then
    if ! curl -fsSL "$url" -o "$tmp_dir/$filename"; then
        echo "Warning: Runtime bundle not found, falling back to standalone binary." >&2
        runtime=""
        filename="llm-${combo}.zip"
        url="${base_url}/${filename}"
        curl -fsSL "$url" -o "$tmp_dir/$filename"
    fi
else
    curl -fsSL "$url" -o "$tmp_dir/$filename"
fi
unzip -q "$tmp_dir/$filename" -d "$tmp_dir"

src="$tmp_dir/llm-${combo}"
if [[ "$runtime" == "node" ]]; then
    src="$tmp_dir/llm-node.js"
fi
if [[ "$os" == "windows" && -z "$runtime" ]]; then
    src="$tmp_dir/llm-windows-x64.exe"
fi

if [[ ! -f "$src" ]]; then
    echo "Downloaded archive does not contain expected binary: $src" >&2
    exit 1
fi

dest="$install_dir/llm"
if [[ "$os" == "windows" ]]; then
    dest="$install_dir/llm.exe"
fi

mv "$src" "$dest"
if [[ "$runtime" == "node" || "$runtime" == "bun" ]]; then
    tmp_file="${dest}.tmp"
    if [[ "$runtime" == "node" ]]; then
        printf '#!/usr/bin/env node\n' > "$tmp_file"
    fi
    cat "$dest" >> "$tmp_file"
    mv "$tmp_file" "$dest"
fi
chmod 755 "$dest"

echo "Installed to $dest"

if [[ ":$PATH:" != *":$install_dir:"* ]]; then
    echo "Add this to your shell profile:" >&2
    echo "  export PATH=\"$install_dir:\$PATH\"" >&2
fi
